#!/bin/bash
# 检查叮咚买菜是否有可配送时段,有则通过Bark推送

# (*)请填充BarkId
barkId="mTYrUdts2GLgxWhKe7Z4u4"

while :; do

echo "正在检查是否有可用配送时段..."

# (*)请填充cURL命令,2选1填充,别忘记输出到tmp.json
# curl https://maicai.api.ddxq.mobi/order/getReserveTime > tmp.json
curl -k -i --raw -o 0.dat -X POST -d "uid=5b13a1de15e0fc7a0f32f307&longitude=121.664292&latitude=31.032674&station_id=5b1decd545cd4269678b800e&city_number=0101&api_version=9.49.1&app_version=2.81.4&applet_source=&channel=applet&app_client_id=4&sharer_uid=&s_id=70be1cde41ee58dca3ad7e3a3598cc74&openid=osP8I0ZXnOhO2CpnVOx-Vt9GGfI0&h5_source=&device_token=WHJMrwNw1k%%2FF0qdLNvE01AfvSFlTrRW3sx0vfPHvhPcIwOax4eTT8TH%%2Bt4u20U%%2B8FhvlQcRmIiy3ZXtymn9Z%%2Bqf39I%%2FWWGSp1dCW1tldyDzmauSxIJm5Txg%%3D%%3D1487582755342&address_id=6172144d59e7120001e08ebd&group_config_id=&products=%%5B%%5B%%7B%%22type%%22%%3A1%%2C%%22id%%22%%3A%%225d5b6c65b0055a0b5940ddab%%22%%2C%%22price%%22%%3A%%222.29%%22%%2C%%22count%%22%%3A1%%2C%%22description%%22%%3A%%22%%22%%2C%%22sizes%%22%%3A%%5B%%5D%%2C%%22cart_id%%22%%3A%%225d5b6c65b0055a0b5940ddab%%22%%2C%%22parent_id%%22%%3A%%22%%22%%2C%%22parent_batch_type%%22%%3A-1%%2C%%22category_path%%22%%3A%%2258f9d213936edfe4568b569a%%2C58fbf4d5936edfe4568b5986%%22%%2C%%22manage_category_path%%22%%3A%%226%%2C1100%%2C1101%%22%%2C%%22activity_id%%22%%3A%%22%%22%%2C%%22sku_activity_id%%22%%3A%%22%%22%%2C%%22conditions_num%%22%%3A%%22%%22%%2C%%22product_name%%22%%3A%%22%%E7%%BB%%BF%%E8%%B1%%86%%E8%%8A%%BD%%20300g%%2F%%E4%%BB%%BD%%22%%2C%%22product_type%%22%%3A0%%2C%%22small_image%%22%%3A%%22https%%3A%%2F%%2Fimg.ddimg.mobi%%2Fproduct%%2Ffe97cfd4799ee1617000396136.jpg%%3Fwidth%%3D800%%26height%%3D800%%22%%2C%%22total_price%%22%%3A%%222.29%%22%%2C%%22origin_price%%22%%3A%%222.29%%22%%2C%%22total_origin_price%%22%%3A%%222.29%%22%%2C%%22no_supplementary_price%%22%%3A%%222.29%%22%%2C%%22no_supplementary_total_price%%22%%3A%%222.29%%22%%2C%%22size_price%%22%%3A%%220.00%%22%%2C%%22buy_limit%%22%%3A0%%2C%%22price_type%%22%%3A0%%2C%%22promotion_num%%22%%3A0%%2C%%22instant_rebate_money%%22%%3A%%220.00%%22%%2C%%22is_invoice%%22%%3A1%%2C%%22sub_list%%22%%3A%%5B%%5D%%2C%%22is_booking%%22%%3A0%%2C%%22is_bulk%%22%%3A0%%2C%%22view_total_weight%%22%%3A%%22%%E4%%BB%%BD%%22%%2C%%22net_weight%%22%%3A%%22300%%22%%2C%%22net_weight_unit%%22%%3A%%22g%%22%%2C%%22storage_value_id%%22%%3A0%%2C%%22temperature_layer%%22%%3A%%22%%22%%2C%%22sale_batches%%22%%3A%%7B%%22batch_type%%22%%3A-1%%7D%%2C%%22is_shared_station_product%%22%%3A0%%2C%%22delivery_date_tag%%22%%3A%%22%%E4%%BB%%85%%E4%%BB%%8A%%E6%%97%%A5%%E5%%8F%%AF%%E9%%85%%8D%%E9%%80%%81%%22%%2C%%22is_gift%%22%%3A0%%2C%%22supplementary_list%%22%%3A%%5B%%5D%%2C%%22order_sort%%22%%3A1%%2C%%22is_presale%%22%%3A0%%7D%%2C%%7B%%22type%%22%%3A1%%2C%%22id%%22%%3A%%2258ba5a09916edf0d4dc2a9d7%%22%%2C%%22price%%22%%3A%%223.50%%22%%2C%%22count%%22%%3A2%%2C%%22description%%22%%3A%%22%%22%%2C%%22sizes%%22%%3A%%5B%%5D%%2C%%22cart_id%%22%%3A%%2258ba5a09916edf0d4dc2a9d7%%22%%2C%%22parent_id%%22%%3A%%22%%22%%2C%%22parent_batch_type%%22%%3A-1%%2C%%22category_path%%22%%3A%%2258f9d213936edfe4568b569a%%2C58fbf49b936edfe6568b5ac5%%22%%2C%%22manage_category_path%%22%%3A%%221%%2C1030%%2C1038%%22%%2C%%22activity_id%%22%%3A%%22%%22%%2C%%22sku_activity_id%%22%%3A%%22%%22%%2C%%22conditions_num%%22%%3A%%22%%22%%2C%%22product_name%%22%%3A%%22%%E6%%9C%%AC%%E5%%9C%%B0%%E9%%B8%%A1%%E6%%AF%%9B%%E8%%8F%%9C%%20%%E7%%BA%%A6250g%%22%%2C%%22product_type%%22%%3A0%%2C%%22small_image%%22%%3A%%22https%%3A%%2F%%2Fimgnew.ddimg.mobi%%2Fproduct%%2Fec2ba0d4a27f4cb88927c1ba363b772e.jpg%%3Fwidth%%3D800%%26height%%3D800%%22%%2C%%22total_price%%22%%3A%%227.00%%22%%2C%%22origin_price%%22%%3A%%223.50%%22%%2C%%22total_origin_price%%22%%3A%%227.00%%22%%2C%%22no_supplementary_price%%22%%3A%%223.50%%22%%2C%%22no_supplementary_total_price%%22%%3A%%227.00%%22%%2C%%22size_price%%22%%3A%%220.00%%22%%2C%%22buy_limit%%22%%3A0%%2C%%22price_type%%22%%3A0%%2C%%22promotion_num%%22%%3A0%%2C%%22instant_rebate_money%%22%%3A%%220.00%%22%%2C%%22is_invoice%%22%%3A1%%2C%%22sub_list%%22%%3A%%5B%%5D%%2C%%22is_booking%%22%%3A0%%2C%%22is_bulk%%22%%3A0%%2C%%22view_total_weight%%22%%3A%%22%%E4%%BB%%BD%%22%%2C%%22net_weight%%22%%3A%%22250%%22%%2C%%22net_weight_unit%%22%%3A%%22g%%22%%2C%%22storage_value_id%%22%%3A0%%2C%%22temperature_layer%%22%%3A%%22%%22%%2C%%22sale_batches%%22%%3A%%7B%%22batch_type%%22%%3A-1%%7D%%2C%%22is_shared_station_product%%22%%3A0%%2C%%22is_gift%%22%%3A0%%2C%%22supplementary_list%%22%%3A%%5B%%5D%%2C%%22order_sort%%22%%3A2%%2C%%22is_presale%%22%%3A0%%7D%%2C%%7B%%22type%%22%%3A1%%2C%%22id%%22%%3A%%226191c355f0a826b0a6ddc85d%%22%%2C%%22price%%22%%3A%%225.90%%22%%2C%%22count%%22%%3A1%%2C%%22description%%22%%3A%%22%%22%%2C%%22sizes%%22%%3A%%5B%%5D%%2C%%22cart_id%%22%%3A%%226191c355f0a826b0a6ddc85d%%22%%2C%%22parent_id%%22%%3A%%22%%22%%2C%%22parent_batch_type%%22%%3A-1%%2C%%22category_path%%22%%3A%%22%%22%%2C%%22manage_category_path%%22%%3A%%221%%2C1030%%2C1040%%22%%2C%%22activity_id%%22%%3A%%22%%22%%2C%%22sku_activity_id%%22%%3A%%22%%22%%2C%%22conditions_num%%22%%3A%%22%%22%%2C%%22product_name%%22%%3A%%22%%E3%%80%%90%%E5%%8F%%AE%%E5%%92%%9A%%E8%%87%%AA%%E8%%90%%A5%%E5%%86%%9C%%E5%%9C%%BA%%E3%%80%%91%%E8%%8B%%8F%%E5%%B7%%9E%%E9%%9D%%92%%20300g%%2F%%E4%%BB%%BD%%22%%2C%%22product_type%%22%%3A0%%2C%%22small_image%%22%%3A%%22https%%3A%%2F%%2Fimgnew.ddimg.mobi%%2Fproduct%%2F1a98a43e5df44a3c964bd8e7c1cc8084.jpg%%3Fwidth%%3D800%%26height%%3D800%%22%%2C%%22total_price%%22%%3A%%225.90%%22%%2C%%22origin_price%%22%%3A%%225.90%%22%%2C%%22total_origin_price%%22%%3A%%225.90%%22%%2C%%22no_supplementary_price%%22%%3A%%225.90%%22%%2C%%22no_supplementary_total_price%%22%%3A%%225.90%%22%%2C%%22size_price%%22%%3A%%220.00%%22%%2C%%22buy_limit%%22%%3A0%%2C%%22price_type%%22%%3A0%%2C%%22promotion_num%%22%%3A0%%2C%%22instant_rebate_money%%22%%3A%%220.00%%22%%2C%%22is_invoice%%22%%3A1%%2C%%22sub_list%%22%%3A%%5B%%5D%%2C%%22is_booking%%22%%3A0%%2C%%22is_bulk%%22%%3A0%%2C%%22view_total_weight%%22%%3A%%22%%E4%%BB%%BD%%22%%2C%%22net_weight%%22%%3A%%22300%%22%%2C%%22net_weight_unit%%22%%3A%%22g%%22%%2C%%22storage_value_id%%22%%3A0%%2C%%22temperature_layer%%22%%3A%%22%%22%%2C%%22sale_batches%%22%%3A%%7B%%22batch_type%%22%%3A-1%%7D%%2C%%22is_shared_station_product%%22%%3A0%%2C%%22is_gift%%22%%3A0%%2C%%22supplementary_list%%22%%3A%%5B%%5D%%2C%%22order_sort%%22%%3A3%%2C%%22is_presale%%22%%3A0%%7D%%2C%%7B%%22type%%22%%3A1%%2C%%22id%%22%%3A%%225aaf961cc0a1eae5398b45d6%%22%%2C%%22price%%22%%3A%%2213.85%%22%%2C%%22count%%22%%3A1%%2C%%22description%%22%%3A%%22%%22%%2C%%22sizes%%22%%3A%%5B%%5D%%2C%%22cart_id%%22%%3A%%225aaf961cc0a1eae5398b45d6%%22%%2C%%22parent_id%%22%%3A%%22%%22%%2C%%22parent_batch_type%%22%%3A-1%%2C%%22category_path%%22%%3A%%2258f9d213936edfe4568b569a%%2C58fbf4d5936edfe4568b5986%%22%%2C%%22manage_category_path%%22%%3A%%2213%%2C1193%%2C1198%%22%%2C%%22activity_id%%22%%3A%%22%%22%%2C%%22sku_activity_id%%22%%3A%%2262489e2a878a2500019ff521%%22%%2C%%22conditions_num%%22%%3A%%22%%22%%2C%%22product_name%%22%%3A%%22%%E3%%80%%90%%E6%%98%%A5%%E8%%8F%%9C%%E3%%80%%91%%E8%%9A%%95%%E8%%B1%%86%%EF%%BC%%88%%E5%%B8%%A6%%E5%%A3%%B3%%EF%%BC%%89%%20%%E7%%BA%%A61kg%%22%%2C%%22product_type%%22%%3A0%%2C%%22small_image%%22%%3A%%22https%%3A%%2F%%2Fimg.ddimg.mobi%%2Fproduct%%2F126fab20c369f1585931097426.jpg!deliver.product.list%%22%%2C%%22total_price%%22%%3A%%2213.85%%22%%2C%%22origin_price%%22%%3A%%2214.90%%22%%2C%%22total_origin_price%%22%%3A%%2214.90%%22%%2C%%22no_supplementary_price%%22%%3A%%2213.85%%22%%2C%%22no_supplementary_total_price%%22%%3A%%2213.85%%22%%2C%%22size_price%%22%%3A%%220.00%%22%%2C%%22buy_limit%%22%%3A0%%2C%%22price_type%%22%%3A2%%2C%%22promotion_num%%22%%3A0%%2C%%22instant_rebate_money%%22%%3A%%220.00%%22%%2C%%22is_invoice%%22%%3A1%%2C%%22sub_list%%22%%3A%%5B%%5D%%2C%%22is_booking%%22%%3A0%%2C%%22is_bulk%%22%%3A0%%2C%%22view_total_weight%%22%%3A%%22%%E4%%BB%%BD%%22%%2C%%22net_weight%%22%%3A%%221000%%22%%2C%%22net_weight_unit%%22%%3A%%22g%%22%%2C%%22storage_value_id%%22%%3A0%%2C%%22temperature_layer%%22%%3A%%22%%22%%2C%%22sale_batches%%22%%3A%%7B%%22batch_type%%22%%3A-1%%7D%%2C%%22is_shared_station_product%%22%%3A0%%2C%%22is_gift%%22%%3A0%%2C%%22supplementary_list%%22%%3A%%5B%%5D%%2C%%22order_sort%%22%%3A4%%2C%%22is_presale%%22%%3A0%%7D%%2C%%7B%%22type%%22%%3A1%%2C%%22id%%22%%3A%%225f640e5064833b002c272031%%22%%2C%%22price%%22%%3A%%2211.90%%22%%2C%%22count%%22%%3A2%%2C%%22description%%22%%3A%%22%%22%%2C%%22sizes%%22%%3A%%5B%%5D%%2C%%22cart_id%%22%%3A%%225f640e5064833b002c272031%%22%%2C%%22parent_id%%22%%3A%%22%%22%%2C%%22parent_batch_type%%22%%3A-1%%2C%%22category_path%%22%%3A%%22%%22%%2C%%22manage_category_path%%22%%3A%%226%%2C7%%2C1080%%22%%2C%%22activity_id%%22%%3A%%22%%22%%2C%%22sku_activity_id%%22%%3A%%22%%22%%2C%%22conditions_num%%22%%3A%%22%%22%%2C%%22product_name%%22%%3A%%22%%E3%%80%%90%%E4%%BA%%A7%%E5%%9C%%B0%%E7%%89%%B9%%E8%%89%%B2%%E3%%80%%91%%E6%%B8%%A9%%E5%%8E%%BF%%E9%%93%%81%%E6%%A3%%8D%%E5%%B1%%B1%%E8%%8D%%AF%%20400g%%2F%%E4%%BB%%BD%%22%%2C%%22product_type%%22%%3A0%%2C%%22small_image%%22%%3A%%22https%%3A%%2F%%2Fimg.ddimg.mobi%%2Fproduct%%2F4118871ef3c721621508963620.jpg%%3Fwidth%%3D800%%26height%%3D800%%22%%2C%%22total_price%%22%%3A%%2223.80%%22%%2C%%22origin_price%%22%%3A%%2211.90%%22%%2C%%22total_origin_price%%22%%3A%%2223.80%%22%%2C%%22no_supplementary_price%%22%%3A%%2211.90%%22%%2C%%22no_supplementary_total_price%%22%%3A%%2223.80%%22%%2C%%22size_price%%22%%3A%%220.00%%22%%2C%%22buy_limit%%22%%3A0%%2C%%22price_type%%22%%3A0%%2C%%22promotion_num%%22%%3A0%%2C%%22instant_rebate_money%%22%%3A%%220.00%%22%%2C%%22is_invoice%%22%%3A1%%2C%%22sub_list%%22%%3A%%5B%%5D%%2C%%22is_booking%%22%%3A0%%2C%%22is_bulk%%22%%3A0%%2C%%22view_total_weight%%22%%3A%%22%%E4%%BB%%BD%%22%%2C%%22net_weight%%22%%3A%%22400%%22%%2C%%22net_weight_unit%%22%%3A%%22g%%22%%2C%%22storage_value_id%%22%%3A0%%2C%%22temperature_layer%%22%%3A%%22%%22%%2C%%22sale_batches%%22%%3A%%7B%%22batch_type%%22%%3A-1%%7D%%2C%%22is_shared_station_product%%22%%3A0%%2C%%22is_gift%%22%%3A0%%2C%%22supplementary_list%%22%%3A%%5B%%5D%%2C%%22order_sort%%22%%3A5%%2C%%22is_presale%%22%%3A0%%7D%%2C%%7B%%22type%%22%%3A1%%2C%%22id%%22%%3A%%2259941969936edffb148e1b83%%22%%2C%%22price%%22%%3A%%2217.90%%22%%2C%%22count%%22%%3A2%%2C%%22description%%22%%3A%%22%%22%%2C%%22sizes%%22%%3A%%5B%%5D%%2C%%22cart_id%%22%%3A%%2259941969936edffb148e1b83%%22%%2C%%22parent_id%%22%%3A%%22%%22%%2C%%22parent_batch_type%%22%%3A-1%%2C%%22category_path%%22%%3A%%2258f9e531936edfe5568b5747%%2C5b1001d3c5702e317c8bac71%%22%%2C%%22manage_category_path%%22%%3A%%22120%%2C121%%2C1007%%22%%2C%%22activity_id%%22%%3A%%22%%22%%2C%%22sku_activity_id%%22%%3A%%22%%22%%2C%%22conditions_num%%22%%3A%%22%%22%%2C%%22product_name%%22%%3A%%22%%E6%%B3%%B0%%E6%%A3%%AE%%E5%%86%%B7%%E9%%B2%%9C%%E9%%B8%%A1%%E7%%BF%%85%%E6%%A0%%B9%%20500g%%22%%2C%%22product_type%%22%%3A0%%2C%%22small_image%%22%%3A%%22https%%3A%%2F%%2Fimgnew.ddimg.mobi%%2Fproduct%%2Fa45145f6afc241a69aa61ae4683aee4d.jpg%%3Fwidth%%3D800%%26height%%3D800%%22%%2C%%22total_price%%22%%3A%%2235.80%%22%%2C%%22origin_price%%22%%3A%%2217.90%%22%%2C%%22total_origin_price%%22%%3A%%2235.80%%22%%2C%%22no_supplementary_price%%22%%3A%%2217.90%%22%%2C%%22no_supplementary_total_price%%22%%3A%%2235.80%%22%%2C%%22size_price%%22%%3A%%220.00%%22%%2C%%22buy_limit%%22%%3A0%%2C%%22price_type%%22%%3A0%%2C%%22promotion_num%%22%%3A0%%2C%%22instant_rebate_money%%22%%3A%%220.00%%22%%2C%%22is_invoice%%22%%3A1%%2C%%22sub_list%%22%%3A%%5B%%5D%%2C%%22is_booking%%22%%3A0%%2C%%22is_bulk%%22%%3A0%%2C%%22view_total_weight%%22%%3A%%22%%E7%%9B%%92%%22%%2C%%22net_weight%%22%%3A%%22500%%22%%2C%%22net_weight_unit%%22%%3A%%22g%%22%%2C%%22storage_value_id%%22%%3A2%%2C%%22temperature_layer%%22%%3A%%220~4%%E2%%84%%83%%22%%2C%%22sale_batches%%22%%3A%%7B%%22batch_type%%22%%3A-1%%7D%%2C%%22is_shared_station_product%%22%%3A0%%2C%%22is_gift%%22%%3A0%%2C%%22supplementary_list%%22%%3A%%5B%%5D%%2C%%22order_sort%%22%%3A6%%2C%%22is_presale%%22%%3A0%%7D%%5D%%5D&isBridge=false&nars=55e224b7cdab51a9706887475dfea7c1&sesi=fbMXSUyba521996a5a2c4d99dae5f7f6f3b281d"  -H "Host: maicai.api.ddxq.mobi" -H "Connection: keep-alive" -H "Cookie: DDXQSESSID=70be1cde41ee58dca3ad7e3a3598cc74" -H "User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36 MicroMessenger/7.0.9.501 NetType/WIFI MiniProgramEnv/Windows WindowsWechat" -H "content-type: application/x-www-form-urlencoded" -H "ddmc-api-version: 9.49.1" -H "ddmc-app-client-id: 4" -H "ddmc-build-version: 2.81.4" -H "ddmc-channel: applet" -H "ddmc-city-number: 0101" -H "ddmc-device-id: osP8I0ZXnOhO2CpnVOx-Vt9GGfI0" -H "ddmc-ip: " -H "ddmc-latitude: 31.032674" -H "ddmc-longitude: 121.664292" -H "ddmc-os-version: [object Undefined]" -H "ddmc-station-id: 5b1decd545cd4269678b800e" -H "ddmc-uid: 5b13a1de15e0fc7a0f32f307" -H "Referer: https://servicewechat.com/wx1e113254eda17715/421/page-frame.html" -H "Accept-Encoding: gzip, deflate, br" "https://maicai.api.ddxq.mobi/order/getMultiReserveTime" > tmp.json

responseCheckCount=`cat tmp.json | grep -c 'station_id'`

if [[ $responseCheckCount -ne 1 ]]; then
    cat tmp.json
    echo "😭 抱歉 请检查cURL命令是否能获取到正确的数据"
    exit 1
fi

# try parse as getMultiReserveTime
availableCount=`cat tmp.json | jq -r '.data[0]?.time[0].times[].disableType' | grep -c 0`

# parse as getReserveTime
# availableCount=`cat tmp.json | jq -r '.data.time[0].times[].disableType' | grep -c 0`

if [[ $availableCount -gt 0 ]]; then
    echo "🎉 恭喜 发现可用的配送时段 请尽快下单!"
    curl "https://api.day.app/$barkId/叮咚买菜有可用配送时段请尽快下单/"
    exit 0
fi

echo "无可用配送时段 休眠15秒再试..."
sleep 15

done